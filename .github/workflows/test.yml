name: Tests_CICD

on:
  push:
    branches:
      - main  # or any branch you want to trigger actions from

jobs:
  build:
    runs-on: windows-latest

    steps:
      # Checkout the code from GitHub repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Set up Python 3.12.5
      - name: Set up Python 3.12.5
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.5'

      # Install dependencies from requirements.txt
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Install Playwright Browsers
      - name: Install Playwright Browsers
        run: |
          python -m playwright install

      - name: Install Allure Commandline on Windows
        run: |
            # Download the Allure command-line tool zip file
            Invoke-WebRequest -Uri "https://github.com/allure-framework/allure2/releases/download/2.32.0/allure-2.32.0.zip" -OutFile "allure.zip"
            
            # Extract the zip file to the current directory
            Expand-Archive -Path "allure.zip" -DestinationPath "allure"
            
            # Verify the extraction, ensure allure.bat exists
            if (Test-Path "allure\allure-2.32.0\bin\allure.bat") {
            Write-Host "allure.bat found"
            } else {
            Write-Host "allure.bat not found"
            exit 1
            }
            
            # Move the Allure directory to a common location
            $allurePath = "C:\allure"
            if (-not (Test-Path $allurePath)) {
            New-Item -Path $allurePath -ItemType Directory
            }
            move-item -Path "allure\allure-2.32.0" -Destination $allurePath -Force
            
            # Persist Allure to PATH
            [System.Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$allurePath\allure-2.32.0\bin", [System.EnvironmentVariableTarget]::Machine)

      - name: Verify Allure installation
        run: |
                # Verify Allure is installed correctly
                & "C:\allure\allure-2.32.0\bin\allure.bat" --version

      - name: Run Tests with Allure results
        continue-on-error: true
        run: |
                pytest --alluredir=allure-results --maxfail=1 --disable-warnings

      - name: Generate Allure Report
        run: |
             & "C:\allure\allure-2.32.0\bin\allure.bat" generate allure-results --clean -o allure-report
      
      - name: Set up gh-pages branch
        run: |
             git fetch origin gh-pages
             git checkout gh-pages || git checkout -b gh-pages

      - name: Push changes to gh-pages
        run: |
          git config --global user.name "ranjangowda123"
          git config --global user.email "ranjan@reckonsys.com"
          git remote set-url origin https://${{ secrets.GH_TOKEN }}@github.com/ranjangowda123/Signedly.git
          git checkout gh-pages || git checkout -b gh-pages
          git add .
          git commit -m "Add Allure report"
          git push origin gh-pages
     
